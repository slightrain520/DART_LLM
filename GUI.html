<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART_LLM AI åŠ©æ‰‹</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- é…ç½®Tailwindä¸»é¢˜ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        neutral: {
                            100: '#F5F7FA',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 12px rgba(0, 0, 0, 0.05)',
                        'hover': '0 8px 24px rgba(0, 0, 0, 0.1)',
                    }
                },
            }
        }
    </script>
    
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-balance {
                text-wrap: balance;
            }
        }
    </style>
    
    <style>
        /* å…¨å±€åŠ¨ç”»å®šä¹‰ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slide-up {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .animate-slide-up {
            animation: slide-up 0.3s ease forwards;
        }
        
        .typing-indicator span {
            animation: pulse 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-700 min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-lg bg-primary flex items-center justify-center text-white">
                    <i class="fa fa-bolt text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-neutral-700">DART_LLM åŠ©æ‰‹</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
                    <i class="fa fa-moon-o text-neutral-500"></i>
                </button>
                <button id="history-btn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
                    <i class="fa fa-history text-neutral-500"></i>
                </button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-neutral-100 transition-colors">
                    <i class="fa fa-cog text-neutral-500"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        <!-- èŠå¤©çª—å£ -->
        <div class="w-full lg:w-3/4 flex flex-col bg-white rounded-xl shadow-card overflow-hidden">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="p-4 border-b border-neutral-200 flex justify-between items-center">
                <h2 class="font-semibold text-neutral-600">å¯¹è¯</h2>
                <div class="flex space-x-2">
                    <button id="clear-chat" class="text-sm text-neutral-500 hover:text-primary transition-colors">
                        <i class="fa fa-trash-o mr-1"></i> æ¸…ç©º
                    </button>
                </div>
            </div>
            
            <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
            <div id="chat-container" class="flex-1 p-4 overflow-y-auto scrollbar-hide space-y-6">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="animate-slide-up">
                    <div class="flex items-start space-x-3">
                        <div class="w-9 h-9 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white">
                            <i class="fa fa-robot"></i>
                        </div>
                        <div class="max-w-[85%] bg-neutral-100 rounded-2xl rounded-tl-none p-4">
                            <p class="text-neutral-700 text-balance">
                                æ‚¨å¥½ï¼æˆ‘æ˜¯ DART_LLM ç½‘ç»œå®‰å…¨é—®ç­”åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨è§£ç­”ç½‘ç»œå®‰å…¨ç›¸å…³é—®é¢˜ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="p-4 border-t border-neutral-200">
                <form id="chat-form" class="relative">
                    <textarea 
                        id="user-input" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                        class="w-full p-4 pr-12 rounded-xl border border-neutral-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none transition-all min-h-[100px]"
                    ></textarea>
                    <button 
                        type="submit" 
                        class="absolute right-3 bottom-3 w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center hover:bg-primary/90 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
                    >
                        <i class="fa fa-paper-plane-o"></i>
                    </button>
                </form>
                <div class="mt-2 text-xs text-neutral-400 flex justify-between">
                    <span>æ”¯æŒ Markdown æ ¼å¼</span>
                    <span>æŒ‰ Shift+Enter æ¢è¡Œ</span>
                </div>
            </div>
        </div>
        
        <!-- ä¾§è¾¹æ  - å†å²è®°å½•å’Œé…ç½®ä¿¡æ¯ -->
        <div class="w-full lg:w-1/4 space-y-6">
            <!-- ä¼šè¯å†å² -->
            <div class="bg-white rounded-xl shadow-card overflow-hidden">
                <div class="p-4 border-b border-neutral-200">
                    <h3 class="font-semibold text-neutral-600">ä¼šè¯å†å²</h3>
                </div>
                <div id="history-container" class="p-2 max-h-[300px] overflow-y-auto scrollbar-hide">
                    <!-- å†å²è®°å½•ä¼šé€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    <div class="text-center text-neutral-400 py-8 text-sm">
                        æš‚æ— å†å²è®°å½•
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="bg-white rounded-xl shadow-card overflow-hidden">
                <div class="p-4 border-b border-neutral-200">
                    <h3 class="font-semibold text-neutral-600">é…ç½®ä¿¡æ¯</h3>
                </div>
                <div class="p-4 text-sm space-y-2">
                    <div class="flex justify-between">
                        <span class="text-neutral-500">API åœ°å€</span>
                        <span class="text-neutral-700 truncate max-w-[60%]">http://10.1.0.220:9002/api</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-neutral-500">æ•°æ®åº“</span>
                        <span class="text-neutral-700">common_dataset</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-neutral-500">æ¨¡å‹å‚æ•°</span>
                        <span class="text-neutral-700">temp=0.1, max=500</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-neutral-500">Token çŠ¶æ€</span>
                        <span class="text-green-500"><i class="fa fa-check-circle mr-1"></i>å·²è®¾ç½®</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="bg-white border-t border-neutral-200 py-4">
        <div class="container mx-auto px-4 text-center text-sm text-neutral-500">
            <p>Â© 2025 DART_LLM AI åŠ©æ‰‹ | ç½‘ç»œå®‰å…¨ä¸“ç”¨é—®ç­”ç³»ç»Ÿ</p>
        </div>
    </footer>

    <!-- åŠ è½½ä¸­æ¨¡æ€æ¡† -->
    <div id="loading-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center max-w-xs w-full mx-4">
            <div class="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-4"></div>
            <h3 class="font-medium text-neutral-700 mb-2">æ­£åœ¨å¤„ç†</h3>
            <p class="text-sm text-neutral-500 text-center" id="loading-message">æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“å¹¶ç”Ÿæˆå›ç­”...</p>
        </div>
    </div>

    <script>
        // DOM å…ƒç´ 
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const clearChatBtn = document.getElementById('clear-chat');
        const historyContainer = document.getElementById('history-container');
        const loadingModal = document.getElementById('loading-modal');
        const loadingMessage = document.getElementById('loading-message');
        const themeToggle = document.getElementById('theme-toggle');
        
        // å­˜å‚¨èŠå¤©å†å²
		let currentSessionId = sessionStorage.getItem('dart_llm_session_id');
		if (!currentSessionId) {
			currentSessionId = generateSessionId();
			sessionStorage.setItem('dart_llm_session_id', currentSessionId); // æ”¹ä¸ºsessionStorage
			console.log("æ–°ä¼šè¯IDï¼ˆæ ‡ç­¾é¡µç‹¬ç«‹ï¼‰ï¼š", currentSessionId);
		}
		let chatHistory = [];
        
        // ç”Ÿæˆå”¯ä¸€ä¼šè¯ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(message = 'æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...') {
            loadingMessage.textContent = message;
            loadingModal.classList.remove('hidden');
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            loadingModal.classList.add('hidden');
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'animate-slide-up flex items-start justify-end space-x-3';
            messageDiv.innerHTML = `
                <div class="max-w-[85%] bg-primary text-white rounded-2xl rounded-tr-none p-4">
                    <p class="text-balance">${text}</p>
                </div>
                <div class="w-9 h-9 rounded-full bg-neutral-300 flex-shrink-0 flex items-center justify-center text-neutral-600">
                    <i class="fa fa-user"></i>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            const messageObj = {
                id: Date.now(),
                role: 'user',
                content: text,
                timestamp: new Date()
            };
            chatHistory.push(messageObj);
            updateHistoryPanel();
        }
        
        // æ·»åŠ AIæ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addAiMessage(text, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'animate-slide-up flex items-start space-x-3';
            
            if (isLoading) {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                messageDiv.innerHTML = `
                    <div class="w-9 h-9 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="max-w-[85%] bg-neutral-100 rounded-2xl rounded-tl-none p-4">
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-neutral-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-neutral-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-neutral-400 rounded-full"></span>
                        </div>
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºAIå›å¤
                messageDiv.innerHTML = `
                    <div class="w-9 h-9 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="max-w-[85%] bg-neutral-100 rounded-2xl rounded-tl-none p-4">
                        <p class="text-neutral-700 text-balance">${formatMessage(text)}</p>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆç®€å•å¤„ç†æ¢è¡Œå’Œé“¾æ¥ï¼‰
        function formatMessage(text) {
            // å¤„ç†æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');
            // å¤„ç†é“¾æ¥
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary hover:underline">$1</a>');
            return text;
        }
        
        // æ›´æ–°å†å²è®°å½•é¢æ¿
        function updateHistoryPanel() {
            if (chatHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-neutral-400 py-8 text-sm">
                        æš‚æ— å†å²è®°å½•
                    </div>
                `;
                return;
            }
            
            // åªæ˜¾ç¤ºç”¨æˆ·çš„é—®é¢˜ä½œä¸ºå†å²è®°å½•æ¡ç›®
            const userQuestions = chatHistory.filter(item => item.role === 'user');
            
            if (userQuestions.length === 0) return;
            
            historyContainer.innerHTML = '';
            userQuestions.forEach((question, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-3 rounded-lg hover:bg-neutral-100 transition-colors cursor-pointer mb-1 text-sm';
                historyItem.textContent = question.content.length > 50 
                    ? question.content.substring(0, 50) + '...' 
                    : question.content;
                historyItem.addEventListener('click', () => {
                    // æ»šåŠ¨åˆ°å¯¹åº”çš„æ¶ˆæ¯
                    scrollToMessage(question.id);
                });
                historyContainer.appendChild(historyItem);
            });
        }
        
        // æ»šåŠ¨åˆ°æŒ‡å®šæ¶ˆæ¯
        function scrollToMessage(messageId) {
            const messages = chatContainer.querySelectorAll('div[message-id]');
            for (const msg of messages) {
                if (parseInt(msg.getAttribute('message-id')) === messageId) {
                    msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // é«˜äº®æ˜¾ç¤º
                    msg.classList.add('bg-primary/5');
                    setTimeout(() => {
                        msg.classList.remove('bg-primary/5');
                    }, 2000);
                    break;
                }
            }
        }
        
        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                chatContainer.innerHTML = `
                    <div class="animate-slide-up">
                        <div class="flex items-start space-x-3">
                            <div class="w-9 h-9 rounded-full bg-primary flex-shrink-0 flex items-center justify-center text-white">
                                <i class="fa fa-robot"></i>
                            </div>
                            <div class="max-w-[85%] bg-neutral-100 rounded-2xl rounded-tl-none p-4">
                                <p class="text-neutral-700 text-balance">
                                    æ‚¨å¥½ï¼æˆ‘æ˜¯ DART_LLM ç½‘ç»œå®‰å…¨é—®ç­”åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨è§£ç­”ç½‘ç»œå®‰å…¨ç›¸å…³é—®é¢˜ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory = [];
                currentSessionId = generateSessionId();
                updateHistoryPanel();
            }
        }
        
        async function sendMessage(userMessage) {
			try {
				// 1. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
				showLoading('ğŸ” æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...');
				
				// 2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
				addUserMessage(userMessage);
				userInput.value = '';
				
				// 3. æ·»åŠ AIåŠ è½½æ¶ˆæ¯
				const loadingMessageEl = addAiMessage('', true);
				
				// 4. è°ƒç”¨åç«¯APIï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰- æ–°å¢ä¼ é€’session_id
				const response = await fetch('http://localhost:5000/api/chat', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						query: userMessage,
						session_id: currentSessionId  // ä¼ é€’å½“å‰ä¼šè¯ID
					})
				});
				
				// 5. è§£æAPIå“åº”
				const result = await response.json();
				
				// 6. ç§»é™¤åŠ è½½æ¶ˆæ¯
				loadingMessageEl.remove();
				
				// 7. å¤„ç†å“åº”ç»“æœ
				if (result.status === 'success') {
					addAiMessage(result.answer);  // æ˜¾ç¤ºAIå›ç­”
					// ä¿å­˜åˆ°å†å²è®°å½•
					chatHistory.push({
						id: Date.now(),
						role: 'assistant',
						content: result.answer,
						timestamp: new Date()
					});
				} else {
					// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
					addAiMessage(`âŒ é”™è¯¯ï¼š${result.message}`);
				}
				
				hideLoading();
				
			} catch (error) {
				loadingMessageEl.remove();
				addAiMessage(`æŠ±æ­‰ï¼Œè°ƒç”¨APIå¤±è´¥ï¼š${error.message}`);
				hideLoading();
			}
		}
        
        // äº‹ä»¶ç›‘å¬ï¼šè¡¨å•æäº¤
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });
        
        // äº‹ä»¶ç›‘å¬ï¼šæ¸…ç©ºèŠå¤©
        clearChatBtn.addEventListener('click', clearChat);
        
        // äº‹ä»¶ç›‘å¬ï¼šæ”¯æŒShift+Enteræ¢è¡Œ
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = userInput.value.trim();
                if (message) {
                    sendMessage(message);
                }
            }
        });
        
        // äº‹ä»¶ç›‘å¬ï¼šä¸»é¢˜åˆ‡æ¢
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const icon = themeToggle.querySelector('i');
            if (icon.classList.contains('fa-moon-o')) {
                icon.classList.replace('fa-moon-o', 'fa-sun-o');
                // è¿™é‡Œå¯ä»¥æ·»åŠ æš—è‰²æ¨¡å¼çš„é€»è¾‘
            } else {
                icon.classList.replace('fa-sun-o', 'fa-moon-o');
                // è¿™é‡Œå¯ä»¥æ·»åŠ äº®è‰²æ¨¡å¼çš„é€»è¾‘
            }
        });
    </script>
</body>
</html>